@{
    ViewBag.Title = "Reports";
}

<style>
    .approval-badge { font-size: 0.75rem; padding: 4px 8px; }
    .level-badge { display: inline-block; min-width: 60px; text-align: center; margin: 2px; }
    .detail-row { background-color: #f8f9fa; }
    .detail-row td { padding: 0 !important; }
    .line-items-table { margin: 0; font-size: 0.85rem; }
    .line-items-table th { background-color: #e9ecef; }
    .approval-timeline { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .approval-level-card {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.8rem;
        min-width: 100px;
        text-align: center;
    }
    .level-pending { border-color: #ffc107; background-color: #fff8e1; }
    .level-approved { border-color: #28a745; background-color: #e8f5e9; }
    .level-rejected { border-color: #dc3545; background-color: #fce4ec; }
    .level-waiting { border-color: #6c757d; background-color: #f5f5f5; color: #999; }
    .arrow-separator { color: #999; font-size: 1.2rem; }
    .doc-row { cursor: pointer; }
    .doc-row:hover { background-color: #f0f4ff; }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-file-earmark-bar-graph me-2"></i>
                My Stock Adjustment Reports
            </h2>

            <!-- Date Filter Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filter</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label for="fromDate" class="form-label fw-semibold">From Date</label>
                            <input type="date" class="form-control" id="fromDate" />
                        </div>
                        <div class="col-md-3">
                            <label for="toDate" class="form-label fw-semibold">To Date</label>
                            <input type="date" class="form-control" id="toDate" />
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" id="btnView" onclick="loadReportData()">
                                <i class="bi bi-search me-1"></i> View
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Data Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Stock Adjustment Records</h5>
                    <span class="badge bg-light text-primary" id="recordCount"></span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered" id="reportTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 30px;"></th>
                                    <th>Document Ref</th>
                                    <th>Date</th>
                                    <th>Created By</th>
                                    <th>Department</th>
                                    <th>Approval Progress</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        <i class="bi bi-calendar-range fs-1"></i>
                                        <p class="mt-2 mb-0">Select a date range and click <strong>View</strong> to load records.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Global Loading Spinner Overlay -->
<div id="globalSpinner" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:99999; justify-content:center; align-items:center;">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width:3rem; height:3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 fw-semibold text-primary" id="spinnerMessage">Loading...</p>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Default: current month range
            var today = new Date();
            var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            $('#fromDate').val(formatDateForInput(firstDay));
            $('#toDate').val(formatDateForInput(today));
        });

        function formatDateForInput(date) {
            var y = date.getFullYear();
            var m = ('0' + (date.getMonth() + 1)).slice(-2);
            var d = ('0' + date.getDate()).slice(-2);
            return y + '-' + m + '-' + d;
        }

        function showSpinner(message) {
            $('#spinnerMessage').text(message || 'Loading...');
            $('#globalSpinner').css('display', 'flex');
        }

        function hideSpinner() {
            $('#globalSpinner').hide();
        }

        function loadReportData() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();

            if (!fromDate || !toDate) {
                alert('Please select both From Date and To Date.');
                return;
            }

            var tbody = $('#reportTableBody');
            tbody.html('<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 mb-0">Loading records...</p></td></tr>');
            $('#recordCount').text('');

            showSpinner('Fetching report data...');

            $.ajax({
                url: '@Url.Action("GetReportData", "Reports")',
                type: 'GET',
                data: { fromDate: fromDate, toDate: toDate },
                success: function (response) {
                    hideSpinner();
                    if (response.success) {
                        displayReportData(response.data);
                    } else {
                        tbody.html('<tr><td colspan="7" class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle fs-3"></i><p class="mt-2 mb-0">' + escapeHtml(response.message) + '</p></td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    hideSpinner();
                    tbody.html('<tr><td colspan="7" class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle fs-3"></i><p class="mt-2 mb-0">Error loading data: ' + escapeHtml(error) + '</p></td></tr>');
                }
            });
        }

        function displayReportData(documents) {
            var tbody = $('#reportTableBody');
            tbody.empty();

            if (!documents || documents.length === 0) {
                tbody.html('<tr><td colspan="7" class="text-center py-4"><i class="bi bi-inbox fs-1 text-muted"></i><p class="mt-2 mb-0 text-muted">No records found for the selected date range.</p></td></tr>');
                $('#recordCount').text('0 records');
                return;
            }

            $('#recordCount').text(documents.length + ' record(s)');

            $.each(documents, function (index, doc) {
                var key = doc.FinYear + '_' + doc.RecNumber;

                // Build approval progress badges
                var progressHtml = buildApprovalProgress(doc);

                // Status badge
                var statusHtml = getOverallStatus(doc);

                // Main document row (merged - no Type column)
                var row = '<tr class="doc-row" data-key="' + key + '">' +
                    '<td class="text-center"><i class="bi bi-chevron-right toggle-icon"></i></td>' +
                    '<td><strong>' + escapeHtml(doc.DocumentReference) + '</strong></td>' +
                    '<td>' + formatDate(doc.Date) + '</td>' +
                    '<td>' + escapeHtml(doc.CreatedBy || '') + '</td>' +
                    '<td>' + escapeHtml(doc.Department || '') + '</td>' +
                    '<td>' + progressHtml + '</td>' +
                    '<td>' + statusHtml + '</td>' +
                    '</tr>';

                // Detail row (hidden by default)
                var detailRow = '<tr class="detail-row" id="detail-' + key + '" style="display:none;">' +
                    '<td colspan="7">' + buildDetailContent(doc) + '</td>' +
                    '</tr>';

                tbody.append(row);
                tbody.append(detailRow);
            });

            // Toggle detail row on click
            $(document).off('click', '.doc-row').on('click', '.doc-row', function (e) {
                if ($(e.target).closest('button').length) return;
                var key = $(this).data('key');
                var detailRow = $('#detail-' + key);
                detailRow.toggle();
                var icon = $(this).find('.toggle-icon');
                icon.toggleClass('bi-chevron-right bi-chevron-down');
            });
        }

        function buildApprovalProgress(doc) {
            if (!doc.Levels || doc.Levels.length === 0) {
                return '<span class="text-muted">No approval levels</span>';
            }

            var html = '<div class="approval-timeline">';
            $.each(doc.Levels, function (i, level) {
                if (i > 0) {
                    html += '<span class="arrow-separator">&#8594;</span>';
                }

                var cssClass = 'level-waiting';
                var icon = '&#9711;';
                if (level.StatusCode === 2) {
                    cssClass = 'level-approved';
                    icon = '&#10003;';
                } else if (level.StatusCode === 3) {
                    cssClass = 'level-rejected';
                    icon = '&#10007;';
                } else if (level.StatusCode === 1) {
                    if (doc.NextPendingLevel === level.Level) {
                        cssClass = 'level-pending';
                        icon = '&#9679;';
                    }
                }

                var tooltip = 'L' + level.Level + ': ' + level.StatusName;
                if (level.ApproverName) {
                    tooltip += ' by ' + level.ApproverName;
                }

                html += '<div class="approval-level-card ' + cssClass + '" title="' + escapeHtml(tooltip) + '">' +
                    '<div><strong>L' + level.Level + '</strong></div>' +
                    '<div>' + icon + ' ' + escapeHtml(level.StatusName) + '</div>' +
                    '</div>';
            });
            html += '</div>';
            return html;
        }

        function getOverallStatus(doc) {
            if (doc.RejectedCount > 0) {
                return '<span class="badge bg-danger approval-badge">Rejected</span>';
            }
            if (doc.ApprovedCount === doc.TotalLevels && doc.TotalLevels > 0) {
                return '<span class="badge bg-success approval-badge">Fully Approved</span>';
            }
            return '<span class="badge bg-warning text-dark approval-badge">' +
                doc.ApprovedCount + '/' + doc.TotalLevels + ' Approved</span>';
        }

        function buildDetailContent(doc) {
            var html = '<div class="p-3">';

            // Approval levels detail
            if (doc.Levels && doc.Levels.length > 0) {
                html += '<h6 class="mb-2"><i class="bi bi-shield-check me-1"></i>Approval Levels</h6>';
                html += '<table class="table table-sm table-bordered line-items-table mb-3">';
                html += '<thead><tr><th>Level</th><th>Status</th><th>Approved By</th><th>Date</th><th>Comments</th></tr></thead>';
                html += '<tbody>';
                $.each(doc.Levels, function (i, level) {
                    var statusBadge = '';
                    if (level.StatusCode === 1) statusBadge = '<span class="badge bg-warning text-dark">Pending</span>';
                    else if (level.StatusCode === 2) statusBadge = '<span class="badge bg-success">Approved</span>';
                    else if (level.StatusCode === 3) statusBadge = '<span class="badge bg-danger">Rejected</span>';

                    html += '<tr>' +
                        '<td><strong>L' + level.Level + '</strong></td>' +
                        '<td>' + statusBadge + '</td>' +
                        '<td>' + escapeHtml(level.ApproverName || '-') + '</td>' +
                        '<td>' + (level.ApprovalDate ? formatDate(level.ApprovalDate) : '-') + '</td>' +
                        '<td>' + escapeHtml(level.Comments || '-') + '</td>' +
                        '</tr>';
                });
                html += '</tbody></table>';
            }

            // Line items
            if (doc.LineItems && doc.LineItems.length > 0) {
                html += '<h6 class="mb-2"><i class="bi bi-list-ul me-1"></i>Line Items</h6>';
                html += '<table class="table table-sm table-bordered line-items-table">';
                html += '<thead><tr><th>#</th><th>Type</th><th>Item Code</th><th>Description</th><th>Location</th><th>Quantity</th><th class="text-end">Cost</th><th class="text-end">Amount</th></tr></thead>';
                html += '<tbody>';
                var totalIncrease = 0;
                var totalDecrease = 0;
                $.each(doc.LineItems, function (i, item) {
                    var amt = parseFloat(item.Amount || 0);
                    if (item.RecType === 12) totalIncrease += amt;
                    else totalDecrease += amt;
                    var typeBadge = item.RecType === 10
                        ? '<span class="badge bg-warning text-dark">Decrease</span>'
                        : '<span class="badge bg-info">Increase</span>';
                    html += '<tr>' +
                        '<td>' + item.Sno + '</td>' +
                        '<td>' + typeBadge + '</td>' +
                        '<td>' + escapeHtml(item.ItemCode) + '</td>' +
                        '<td>' + escapeHtml(item.ItemDesc || '') + '</td>' +
                        '<td>' + (item.RecType === 12 ? escapeHtml(item.ToLocation) : escapeHtml(item.FromLocation)) + ' - ' + (item.RecType === 12 ? escapeHtml(item.ToLocationName || '') : escapeHtml(item.FromLocationName || '')) + '</td>' +
                        '<td>' + item.Quantity + '</td>' +
                        '<td class="text-end">' + parseFloat(item.Cost || 0).toFixed(2) + '</td>' +
                        '<td class="text-end">' + amt.toFixed(2) + '</td>' +
                        '</tr>';
                });
                var netAmount = totalIncrease - totalDecrease;
                html += '</tbody>';
                html += '<tfoot>';
                html += '<tr><td colspan="7" class="text-end fw-bold text-info">Total Increase:</td><td class="text-end fw-bold text-info">' + totalIncrease.toFixed(2) + '</td></tr>';
                html += '<tr><td colspan="7" class="text-end fw-bold text-warning">Total Decrease:</td><td class="text-end fw-bold text-warning">' + totalDecrease.toFixed(2) + '</td></tr>';
                html += '<tr class="table-dark"><td colspan="7" class="text-end fw-bold">Net Amount (Increase - Decrease):</td><td class="text-end fw-bold">' + netAmount.toFixed(2) + '</td></tr>';
                html += '</tfoot>';
                html += '</table>';
            }

            html += '</div>';
            return html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            if (typeof dateString === 'string' && dateString.indexOf('/Date(') > -1) {
                var ticks = parseInt(dateString.replace(/\/Date\((-?\d+)\)\//, '$1'));
                var date = new Date(ticks);
            } else {
                var date = new Date(dateString);
            }
            if (isNaN(date.getTime())) return '';
            var day = ('0' + date.getDate()).slice(-2);
            var month = ('0' + (date.getMonth() + 1)).slice(-2);
            var year = date.getFullYear();
            return day + '/' + month + '/' + year;
        }
    </script>
}
