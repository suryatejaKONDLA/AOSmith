@{
    ViewBag.Title = "Approval";
}

<style>
    .approval-badge { font-size: 0.75rem; padding: 4px 8px; }
    .level-badge { display: inline-block; min-width: 60px; text-align: center; margin: 2px; }
    .detail-row { background-color: #f8f9fa; }
    .detail-row td { padding: 0 !important; }
    .line-items-table { margin: 0; font-size: 0.85rem; }
    .line-items-table th { background-color: #e9ecef; }
    .approval-timeline { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .approval-level-card {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.8rem;
        min-width: 100px;
        text-align: center;
    }
    .level-pending { border-color: #ffc107; background-color: #fff8e1; }
    .level-approved { border-color: #28a745; background-color: #e8f5e9; }
    .level-rejected { border-color: #dc3545; background-color: #fce4ec; }
    .level-waiting { border-color: #6c757d; background-color: #f5f5f5; color: #999; }
    .arrow-separator { color: #999; font-size: 1.2rem; }
    .doc-row { cursor: pointer; }
    .doc-row:hover { background-color: #f0f4ff; }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-check-circle me-2"></i>
                Approval Dashboard
                <small class="text-muted fs-6 ms-2" id="userLevelBadge"></small>
            </h2>

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Stock Adjustment - Approval Queue</h5>
                    <button class="btn btn-sm btn-outline-light" onclick="loadPendingApprovals()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered" id="approvalTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 30px;"></th>
                                    <th>Document Ref</th>
                                    <th>Date</th>
                                    <th>Created By</th>
                                    <th>Department</th>
                                    <th>Approval Progress</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="approvalTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Loading approvals...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Approval Action Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approvalModalLabel">Approval Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Document:</strong> <span id="modalDocRef"></span>
                </div>
                <div class="mb-3">
                    <strong>Your Level:</strong> <span id="modalLevel" class="badge bg-info"></span>
                </div>
                <form id="approvalForm">
                    <input type="hidden" id="approvalFinYear" />
                    <input type="hidden" id="approvalRecNumber" />
                    <input type="hidden" id="approvalAction" />

                    <div class="mb-3">
                        <label for="approvalRemarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="approvalRemarks" rows="3" placeholder="Enter remarks (required for rejection)..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="btnConfirmApprove" style="display:none;">
                    <i class="bi bi-check-circle me-1"></i> Confirm Approve
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmReject" style="display:none;">
                    <i class="bi bi-x-circle me-1"></i> Confirm Reject
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sage API Response Modal (dynamically populated) -->

<!-- Global Loading Spinner Overlay -->
<div id="globalSpinner" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:99999; justify-content:center; align-items:center;">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width:3rem; height:3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 fw-semibold text-primary" id="spinnerMessage">Loading...</p>
    </div>
</div>
@section Scripts {
    <script>
        var currentUserLevel = 0;

        $(document).ready(function () {
            loadPendingApprovals();

            // Approve button click
            $(document).on('click', '.btn-approve-doc', function () {
                var finYear = $(this).data('finyear');
                var recNumber = $(this).data('recnumber');
                var docRef = $(this).data('docref');
                openApprovalModal(finYear, recNumber, docRef, 'approve');
            });

            // Reject button click
            $(document).on('click', '.btn-reject-doc', function () {
                var finYear = $(this).data('finyear');
                var recNumber = $(this).data('recnumber');
                var docRef = $(this).data('docref');
                openApprovalModal(finYear, recNumber, docRef, 'reject');
            });

            // Toggle detail row
            $(document).on('click', '.doc-row', function (e) {
                if ($(e.target).closest('button').length) return;
                var key = $(this).data('key');
                var detailRow = $('#detail-' + key);
                detailRow.toggle();
                var icon = $(this).find('.toggle-icon');
                icon.toggleClass('bi-chevron-right bi-chevron-down');
            });

            // Confirm Approve
            $('#btnConfirmApprove').click(function () {
                processApproval('approve');
            });

            // Confirm Reject
            $('#btnConfirmReject').click(function () {
                processApproval('reject');
            });
        });

        // Spinner helpers
        function showSpinner(message) {
            $('#spinnerMessage').text(message || 'Loading...');
            $('#globalSpinner').css('display', 'flex');
        }

        function hideSpinner() {
            $('#globalSpinner').hide();
        }

        function showError(message) {
            var tbody = $('#approvalTableBody');
            tbody.html('<tr><td colspan="8" class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle fs-3"></i><p class="mt-2 mb-0">' + message + '</p></td></tr>');
        }

        function openApprovalModal(finYear, recNumber, docRef, action) {
            $('#approvalFinYear').val(finYear);
            $('#approvalRecNumber').val(recNumber);
            $('#approvalAction').val(action);
            $('#modalDocRef').text(docRef);
            $('#modalLevel').text('L' + currentUserLevel);
            $('#approvalRemarks').val('');

            if (action === 'approve') {
                $('#approvalModalLabel').text('Approve Document');
                $('#btnConfirmApprove').show();
                $('#btnConfirmReject').hide();
            } else {
                $('#approvalModalLabel').text('Reject Document');
                $('#btnConfirmApprove').hide();
                $('#btnConfirmReject').show();
            }

            $('#approvalModal').modal('show');
        }

        function loadPendingApprovals() {
            var tbody = $('#approvalTableBody');
            tbody.html('<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 mb-0">Loading approvals...</p></td></tr>');

            showSpinner('Loading approvals from Sage...');

            $.ajax({
                url: '@Url.Action("GetPendingApprovals", "Approval")',
                type: 'GET',
                success: function (response) {
                    hideSpinner();
                    if (response.success) {
                        currentUserLevel = response.userApprovalLevel;
                        $('#userLevelBadge').html('<span class="badge bg-info">Your Level: L' + currentUserLevel + '</span>');
                        displayApprovals(response.data);
                    } else {
                        showError(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    hideSpinner();
                    showError('Error loading approvals: ' + error);
                }
            });
        }

        function displayApprovals(documents) {
            var tbody = $('#approvalTableBody');
            tbody.empty();

            if (!documents || documents.length === 0) {
                tbody.html('<tr><td colspan="8" class="text-center py-4"><i class="bi bi-inbox fs-1 text-muted"></i><p class="mt-2 mb-0 text-muted">No stock adjustment documents found.</p></td></tr>');
                return;
            }

            $.each(documents, function (index, doc) {
                var key = doc.FinYear + '_' + doc.RecNumber;

                // Build approval progress badges
                var progressHtml = buildApprovalProgress(doc);

                // Status badge
                var statusHtml = getOverallStatus(doc);

                // Action buttons (only if user can approve)
                var actionsHtml = '';
                if (doc.CanApprove) {
                    actionsHtml =
                        '<button class="btn btn-sm btn-success btn-approve-doc me-1" ' +
                        'data-finyear="' + doc.FinYear + '" data-recnumber="' + doc.RecNumber + '" ' +
                        'data-docref="' + doc.DocumentReference + '" title="Approve at L' + currentUserLevel + '">' +
                        '<i class="bi bi-check-circle"></i> Approve</button>' +
                        '<button class="btn btn-sm btn-danger btn-reject-doc" ' +
                        'data-finyear="' + doc.FinYear + '" data-recnumber="' + doc.RecNumber + '" ' +
                        'data-docref="' + doc.DocumentReference + '" title="Reject at L' + currentUserLevel + '">' +
                        '<i class="bi bi-x-circle"></i> Reject</button>';
                } else if (doc.NextPendingLevel === 0) {
                    actionsHtml = '<span class="text-muted fst-italic">Fully Approved</span>';
                } else if (doc.NextPendingLevel === -1) {
                    actionsHtml = '<span class="text-muted fst-italic">Rejected</span>';
                } else {
                    actionsHtml = '<span class="text-muted fst-italic">Awaiting L' + doc.NextPendingLevel + '</span>';
                }

                // Main document row (merged - no Type column)
                var row = '<tr class="doc-row" data-key="' + key + '">' +
                    '<td class="text-center"><i class="bi bi-chevron-right toggle-icon"></i></td>' +
                    '<td><strong>' + doc.DocumentReference + '</strong></td>' +
                    '<td>' + formatDate(doc.Date) + '</td>' +
                    '<td>' + (doc.CreatedBy || '') + '</td>' +
                    '<td>' + (doc.Department || '') + '</td>' +
                    '<td>' + progressHtml + '</td>' +
                    '<td>' + statusHtml + '</td>' +
                    '<td>' + actionsHtml + '</td>' +
                    '</tr>';

                // Detail row (hidden by default)
                var detailRow = '<tr class="detail-row" id="detail-' + key + '" style="display:none;">' +
                    '<td colspan="8">' + buildDetailContent(doc) + '</td>' +
                    '</tr>';

                tbody.append(row);
                tbody.append(detailRow);
            });
        }

        function buildApprovalProgress(doc) {
            if (!doc.Levels || doc.Levels.length === 0) {
                return '<span class="text-muted">No approval levels</span>';
            }

            var html = '<div class="approval-timeline">';
            $.each(doc.Levels, function (i, level) {
                if (i > 0) {
                    html += '<span class="arrow-separator">&#8594;</span>';
                }

                var cssClass = 'level-waiting';
                var icon = '&#9711;'; // circle
                if (level.StatusCode === 2) {
                    cssClass = 'level-approved';
                    icon = '&#10003;'; // checkmark
                } else if (level.StatusCode === 3) {
                    cssClass = 'level-rejected';
                    icon = '&#10007;'; // cross
                } else if (level.StatusCode === 1) {
                    // Pending - check if it's the next level to approve
                    if (doc.NextPendingLevel === level.Level) {
                        cssClass = 'level-pending';
                        icon = '&#9679;'; // filled circle
                    }
                }

                var tooltip = 'L' + level.Level + ': ' + level.StatusName;
                if (level.ApproverName) {
                    tooltip += ' by ' + level.ApproverName;
                }

                html += '<div class="approval-level-card ' + cssClass + '" title="' + tooltip + '">' +
                    '<div><strong>L' + level.Level + '</strong></div>' +
                    '<div>' + icon + ' ' + level.StatusName + '</div>' +
                    '</div>';
            });
            html += '</div>';
            return html;
        }

        function getOverallStatus(doc) {
            if (doc.RejectedCount > 0) {
                return '<span class="badge bg-danger approval-badge">Rejected</span>';
            }
            if (doc.ApprovedCount === doc.TotalLevels && doc.TotalLevels > 0) {
                return '<span class="badge bg-success approval-badge">Fully Approved</span>';
            }
            return '<span class="badge bg-warning text-dark approval-badge">' +
                doc.ApprovedCount + '/' + doc.TotalLevels + ' Approved</span>';
        }

        function buildDetailContent(doc) {
            var html = '<div class="p-3">';

            // Approval levels detail
            if (doc.Levels && doc.Levels.length > 0) {
                html += '<h6 class="mb-2"><i class="bi bi-shield-check me-1"></i>Approval Levels</h6>';
                html += '<table class="table table-sm table-bordered line-items-table mb-3">';
                html += '<thead><tr><th>Level</th><th>Status</th><th>Approved By</th><th>Date</th><th>Comments</th></tr></thead>';
                html += '<tbody>';
                $.each(doc.Levels, function (i, level) {
                    var statusBadge = '';
                    if (level.StatusCode === 1) statusBadge = '<span class="badge bg-warning text-dark">Pending</span>';
                    else if (level.StatusCode === 2) statusBadge = '<span class="badge bg-success">Approved</span>';
                    else if (level.StatusCode === 3) statusBadge = '<span class="badge bg-danger">Rejected</span>';

                    html += '<tr>' +
                        '<td><strong>L' + level.Level + '</strong></td>' +
                        '<td>' + statusBadge + '</td>' +
                        '<td>' + (level.ApproverName || '-') + '</td>' +
                        '<td>' + (level.ApprovalDate ? formatDate(level.ApprovalDate) : '-') + '</td>' +
                        '<td>' + (level.Comments || '-') + '</td>' +
                        '</tr>';
                });
                html += '</tbody></table>';
            }

            // Line items
            if (doc.LineItems && doc.LineItems.length > 0) {
                html += '<h6 class="mb-2"><i class="bi bi-list-ul me-1"></i>Line Items</h6>';
                html += '<table class="table table-sm table-bordered line-items-table">';
                html += '<thead><tr><th>#</th><th>Type</th><th>Item Code</th><th>Description</th><th>Location</th><th>Quantity</th><th class="text-end">Cost</th><th class="text-end">Amount</th></tr></thead>';
                html += '<tbody>';
                var totalAmount = 0;
                $.each(doc.LineItems, function (i, item) {
                    var amt = parseFloat(item.Amount || 0);
                    totalAmount += amt;
                    var typeBadge = item.RecType === 10
                        ? '<span class="badge bg-warning text-dark">Decrease</span>'
                        : '<span class="badge bg-info">Increase</span>';
                    html += '<tr>' +
                        '<td>' + item.Sno + '</td>' +
                        '<td>' + typeBadge + '</td>' +
                        '<td>' + item.ItemCode + '</td>' +
                        '<td>' + (item.ItemDesc || '') + '</td>' +
                        '<td>' + (item.RecType === 12 ? item.ToLocation : item.FromLocation) + ' - ' + (item.RecType === 12 ? (item.ToLocationName || '') : (item.FromLocationName || '')) + '</td>' +
                        '<td>' + item.Quantity + '</td>' +
                        '<td class="text-end">' + parseFloat(item.Cost || 0).toFixed(2) + '</td>' +
                        '<td class="text-end">' + amt.toFixed(2) + '</td>' +
                        '</tr>';
                });
                html += '</tbody>';
                html += '<tfoot><tr><td colspan="8" class="text-end fw-bold">Total Amount:</td><td class="text-end fw-bold">' + totalAmount.toFixed(2) + '</td></tr></tfoot>';
                html += '</table>';
            }

            html += '</div>';
            return html;
        }

        function processApproval(action) {
            var finYear = $('#approvalFinYear').val();
            var recNumber = $('#approvalRecNumber').val();
            var remarks = $('#approvalRemarks').val();

            if (action === 'reject' && !remarks.trim()) {
                alert('Please enter remarks for rejection.');
                return;
            }

            // Disable buttons during processing
            $('#btnConfirmApprove, #btnConfirmReject').prop('disabled', true).text('Processing...');
            showSpinner('Processing approval...');

            $.ajax({
                url: '@Url.Action("ProcessApproval", "Approval")',
                type: 'POST',
                data: {
                    finYear: finYear,
                    recNumber: recNumber,
                    action: action,
                    remarks: remarks
                },
                success: function (response) {
                    hideSpinner();
                    $('#approvalModal').modal('hide');
                    $('#btnConfirmApprove').prop('disabled', false).html('<i class="bi bi-check-circle me-1"></i> Confirm Approve');
                    $('#btnConfirmReject').prop('disabled', false).html('<i class="bi bi-x-circle me-1"></i> Confirm Reject');

                    if (response.success) {
                        if (response.isFullyApproved && response.sageResponse) {
                            showSageResponseModal([response.sageResponse], response.message);
                        } else if (response.sageTransferResponse) {
                            showSageResponseModal([response.sageTransferResponse], response.message);
                        } else {
                            showResultAlert(response.message, true);
                            loadPendingApprovals();
                        }
                    } else {
                        showResultAlert(response.message, false);
                        loadPendingApprovals();
                    }
                },
                error: function (xhr, status, error) {
                    hideSpinner();
                    $('#btnConfirmApprove').prop('disabled', false).html('<i class="bi bi-check-circle me-1"></i> Confirm Approve');
                    $('#btnConfirmReject').prop('disabled', false).html('<i class="bi bi-x-circle me-1"></i> Confirm Reject');
                    alert('Error processing approval: ' + error);
                }
            });
        }

        function showSageResponseModal(sageDataArray, message) {
            var allSuccess = sageDataArray.every(function (s) { return s.isSuccess === true; });
            var alertClass = allSuccess ? 'alert-success' : 'alert-danger';
            var alertIcon = allSuccess ? 'bi-database-check' : 'bi-exclamation-triangle-fill';

            var cardsHtml = '';
            $.each(sageDataArray, function (idx, sageData) {
                var isSuccess = sageData.isSuccess === true;
                var statusClass = isSuccess ? 'success' : 'danger';
                var statusIcon = isSuccess ? 'bi-check-circle-fill' : 'bi-x-circle-fill';

                var cardTitle = (sageData.recTypeName ? sageData.recTypeName + ' - ' : '') + (sageData.docNum || sageData.transferNumber || (isSuccess ? 'Success' : 'Error'));

                cardsHtml += '<div class="card mb-3 border-' + statusClass + ' border-2">' +
                    '<div class="card-header bg-' + statusClass + ' bg-opacity-10 d-flex justify-content-between align-items-center">' +
                    '<span><i class="bi ' + statusIcon + ' text-' + statusClass + ' me-2"></i><strong>' + escapeHtml(cardTitle) + '</strong></span>' +
                    '<span class="badge bg-' + statusClass + '">' + escapeHtml(String(sageData.status || 'Unknown')) + '</span></div>' +
                    '<div class="card-body"><p class="mb-2"><strong>Message:</strong> ' + escapeHtml(sageData.message || 'No message') + '</p>';

                if (sageData.docNum) {
                    cardsHtml += '<p class="mb-2"><strong>Doc #:</strong> ' + escapeHtml(sageData.docNum) + '</p>';
                }
                if (sageData.transferNumber) {
                    cardsHtml += '<p class="mb-2"><strong>Transfer #:</strong> ' + escapeHtml(sageData.transferNumber) + '</p>';
                }

                cardsHtml += '<div class="mt-2">' +
                    '<button class="btn btn-sm btn-outline-primary me-2" type="button" data-bs-toggle="collapse" data-bs-target="#sageReq' + idx + '"><i class="bi bi-arrow-up-circle me-1"></i>View Request</button>' +
                    '<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#sageRes' + idx + '"><i class="bi bi-arrow-down-circle me-1"></i>View Response</button>' +
                    '<div class="collapse mt-2" id="sageReq' + idx + '"><pre class="bg-dark text-light p-3 rounded" style="max-height:300px;overflow-y:auto;font-size:0.85rem;white-space:pre-wrap;">' + escapeHtml(formatJson(sageData.rawRequest) || 'No request data') + '</pre></div>' +
                    '<div class="collapse mt-2" id="sageRes' + idx + '"><pre class="bg-dark text-light p-3 rounded" style="max-height:300px;overflow-y:auto;font-size:0.85rem;white-space:pre-wrap;">' + escapeHtml(formatJson(sageData.rawResponse) || 'No response data') + '</pre></div>' +
                    '</div></div></div>';
            });

            var modalHtml = '<div class="modal fade" id="sageResponseModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">' +
                '<div class="modal-dialog modal-lg"><div class="modal-content">' +
                '<div class="modal-header bg-info text-white"><h5 class="modal-title"><i class="bi bi-cloud-arrow-up me-2"></i>Transaction Results</h5></div>' +
                '<div class="modal-body p-4">' +
                '<div class="alert ' + alertClass + ' mb-4"><i class="bi ' + alertIcon + ' me-2"></i>' + escapeHtml(message) + '</div>' +
                '<h6 class="fw-bold mb-3">Results (' + sageDataArray.length + ' call' + (sageDataArray.length > 1 ? 's' : '') + ')</h6>' + cardsHtml +
                '</div><div class="modal-footer"><button type="button" class="btn btn-primary" id="btnCloseSageModal"><i class="bi bi-check-lg me-2"></i>OK</button></div>' +
                '</div></div></div>';

            $('#sageResponseModal').remove();
            $('body').append(modalHtml);

            var sageModal = new bootstrap.Modal(document.getElementById('sageResponseModal'));
            sageModal.show();

            $('#btnCloseSageModal').on('click', function () {
                sageModal.hide();
                loadPendingApprovals();
            });
        }

        function formatJson(str) {
            if (!str) return '';
            try {
                return JSON.stringify(JSON.parse(str), null, 2);
            } catch (e) {
                return str;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        function showResultAlert(message, isSuccess) {
            var statusClass = isSuccess ? 'success' : 'danger';
            var statusIcon = isSuccess ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
            var alertClass = isSuccess ? 'alert-success' : 'alert-danger';

            var modalHtml = '<div class="modal fade" id="resultAlertModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">' +
                '<div class="modal-dialog"><div class="modal-content">' +
                '<div class="modal-header bg-' + statusClass + ' bg-opacity-10 border-0">' +
                '<h5 class="modal-title text-' + statusClass + '"><i class="bi ' + statusIcon + ' me-2"></i>' + (isSuccess ? 'Success' : 'Error') + '</h5></div>' +
                '<div class="modal-body p-4">' +
                '<div class="alert ' + alertClass + ' mb-0"><i class="bi ' + statusIcon + ' me-2"></i>' + escapeHtml(message) + '</div>' +
                '</div><div class="modal-footer border-0"><button type="button" class="btn btn-primary" data-bs-dismiss="modal"><i class="bi bi-check-lg me-2"></i>OK</button></div>' +
                '</div></div></div>';

            $('#resultAlertModal').remove();
            $('body').append(modalHtml);

            var alertModal = new bootstrap.Modal(document.getElementById('resultAlertModal'));
            alertModal.show();
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            // Handle ASP.NET /Date(ticks)/ format
            if (typeof dateString === 'string' && dateString.indexOf('/Date(') > -1) {
                var ticks = parseInt(dateString.replace(/\/Date\((-?\d+)\)\//, '$1'));
                var date = new Date(ticks);
            } else {
                var date = new Date(dateString);
            }
            if (isNaN(date.getTime())) return '';
            var day = ('0' + date.getDate()).slice(-2);
            var month = ('0' + (date.getMonth() + 1)).slice(-2);
            var year = date.getFullYear();
            return day + '/' + month + '/' + year;
        }
    </script>
}
